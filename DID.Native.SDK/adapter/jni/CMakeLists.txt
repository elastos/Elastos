project(spvadapterjni VERSION 1.0.0 LANGUAGES CXX)

set(CMAKE_VERBOSE_MAKEFILE TRUE)

FIND_PACKAGE(JNI REQUIRED)
FIND_PACKAGE(Java REQUIRED)

include(ProjectDefaults)

# JNI wrapper was generated by SWIG
# swig -java -module SPVAdapter \
#       -package org.elastos.did.adapter \
#       -outdir java/org/elastos/did/adapter \
#       -o spvadapter_wrap.c \
#       spvadapter.i

if(NOT DEFINED JDK_HOME)
    if (NOT DEFINED ENV{JDK_HOME})
        message(FATAL_ERROR "JDK_HOME variable not set.")
    endif()

    set(JDK_HOME $ENV{JDK_HOME})
endif()

set(SRC
    spvadapter_wrap.c)

set(LIBS
    spvadapter-static
    spvsdk
    ssl
    crypto
    curl
    sqlite3
    fruit
    spdlog
    boost_system
    boost_thread
    boost_filesystem)

set(SYSTEM_LIBS
    z)

if(LINUX OR DARWIN)
set(SYSTEM_LIBS
    ${SYSTEM_LIBS}
    resolv)
endif()

include_directories(
    BEFORE
    ../spvadapter
    ${JDK_HOME}/include
    ${JDK_HOME}/include/darwin
    ${JDK_HOME}/include/linux
    ${PROJECT_INT_DIST_DIR}/include)

if(DARWIN)
    set(CMAKE_SHARED_LIBRARY_SUFFIX .jnilib)
endif()

if(WIN32)
    add_definitions(
        -DWIN32_LEAN_AND_MEAN
        -D_CRT_SECURE_NO_WARNINGS
        -D_CRT_NONSTDC_NO_WARNINGS)

    # Force source code encoding to utf-8
    set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} /utf-8")
endif()

link_directories(
    ${JDK_HOME}/lib
    ${PROJECT_INT_DIST_DIR}/lib)

set(SPVADAPTERJNI_DEPENDS spvadapter)

add_library(spvadapterjni SHARED ${SRC})
add_dependencies(spvadapterjni ${SPVADAPTERJNI_DEPENDS})

set_target_properties(spvadapterjni PROPERTIES
    OUTPUT_NAME spvadapterjni)

if(WIN32)
    set_target_properties(spvadapterjni PROPERTIES LINK_FLAGS /FORCE:MULTIPLE)
endif()

target_link_libraries(spvadapterjni ${LIBS} ${SYSTEM_LIBS})

install(TARGETS spvadapterjni
    RUNTIME DESTINATION "bin"
    ARCHIVE DESTINATION "lib"
    LIBRARY DESTINATION "lib")
